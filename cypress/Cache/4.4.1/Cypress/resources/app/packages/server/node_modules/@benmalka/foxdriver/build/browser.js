"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _actor = require("./actor");

var _actor2 = _interopRequireDefault(_actor);

var _client = require("./client");

var _client2 = _interopRequireDefault(_client);

var _tab = require("./tab");

var _tab2 = _interopRequireDefault(_tab);

var _os = require("os");

var _os2 = _interopRequireDefault(_os);

var _child_process = require("child_process");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class Browser extends _actor2.default {
  constructor(host, port) {
    const client = new _client2.default(host, port);
    client.on('error', error => this.emit('error', error));
    client.on('end', () => this.emit('end'));
    client.on('timeout', () => this.emit('timeout'));
    super(client, 'root');
    this.cachedTabs = new Map();
  }

  get preference() {
    return this._get('preference');
  }

  get actorRegistry() {
    return this._get('actorRegistry');
  }

  get addons() {
    return this._get('addons');
  }

  get device() {
    return this._get('device');
  }

  get heapSnapshotFile() {
    return this._get('heapSnapshotFile');
  }

  async connect() {
    await this.client.connect();
    this.client.expectReply(this.name, ({
      traits
    }) => {
      this.traits = traits;
    });
    this.tabs = await this.listTabs();
    return this.tabs;
  }

  disconnect() {
    this.client.disconnect();
  }

  close() {
    this.disconnect();
    /**
     * only shut down browser if started via launcher
     */

    if (!this.firefoxProcess) {
      return console.error('Can\'t close the browser because client was attached to an' + 'already opened Firefox instance');
    }

    this.firefoxProcess.kill();

    if (!this.firefoxProcess.killed) {
      if (_os2.default.platform() === 'win32') {
        (0, _child_process.spawn)('taskkill', ['/f', '/IM', 'firefox.exe', '/t']);
      } else if (_os2.default.platform() === 'darwin' || _os2.default.platform() === 'linux') {
        (0, _child_process.spawn)('killall', ['-q', '-I', 'firefox']);
      }
    }
  }

  async listTabs() {
    let listTabsResponse = await this.request('listTabs');

    if (!listTabsResponse.tabs) {
      listTabsResponse = await this.request('listTabs');
    }

    this.setActors(listTabsResponse);
    const tabList = await Promise.all(listTabsResponse.tabs.map(async tab => {
      if (this.cachedTabs.has(tab.actor)) {
        return this.cachedTabs.get(tab.actor);
      }

      let newTab = new _tab2.default(this.client, tab.actor, tab);
      this.cachedTabs.set(tab.actor, newTab); // Firefox 75: getTarget

      if (!tab.url) {
        await newTab.getTarget();
      }

      return newTab;
    }));

    this._cleanCache(listTabsResponse.tabs.map(tab => tab.actor));

    return tabList;
  }

  _cleanCache(activeTabs) {
    Array.from(this.cachedTabs.keys()).forEach(tabName => {
      if (!activeTabs.includes(tabName)) {
        this.cachedTabs.delete(tabName);
      }
    });
  }

}

exports.default = Browser;
module.exports = exports["default"];
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2xpYi9icm93c2VyLmpzIl0sIm5hbWVzIjpbIkJyb3dzZXIiLCJBY3RvciIsImNvbnN0cnVjdG9yIiwiaG9zdCIsInBvcnQiLCJjbGllbnQiLCJDbGllbnQiLCJvbiIsImVycm9yIiwiZW1pdCIsImNhY2hlZFRhYnMiLCJNYXAiLCJwcmVmZXJlbmNlIiwiX2dldCIsImFjdG9yUmVnaXN0cnkiLCJhZGRvbnMiLCJkZXZpY2UiLCJoZWFwU25hcHNob3RGaWxlIiwiY29ubmVjdCIsImV4cGVjdFJlcGx5IiwibmFtZSIsInRyYWl0cyIsInRhYnMiLCJsaXN0VGFicyIsImRpc2Nvbm5lY3QiLCJjbG9zZSIsImZpcmVmb3hQcm9jZXNzIiwiY29uc29sZSIsImtpbGwiLCJraWxsZWQiLCJvcyIsInBsYXRmb3JtIiwibGlzdFRhYnNSZXNwb25zZSIsInJlcXVlc3QiLCJzZXRBY3RvcnMiLCJ0YWJMaXN0IiwiUHJvbWlzZSIsImFsbCIsIm1hcCIsInRhYiIsImhhcyIsImFjdG9yIiwiZ2V0IiwibmV3VGFiIiwiVGFiIiwic2V0IiwidXJsIiwiZ2V0VGFyZ2V0IiwiX2NsZWFuQ2FjaGUiLCJhY3RpdmVUYWJzIiwiQXJyYXkiLCJmcm9tIiwia2V5cyIsImZvckVhY2giLCJ0YWJOYW1lIiwiaW5jbHVkZXMiLCJkZWxldGUiXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFFZSxNQUFNQSxPQUFOLFNBQXNCQyxlQUF0QixDQUE0QjtBQUN2Q0MsRUFBQUEsV0FBVyxDQUFFQyxJQUFGLEVBQVFDLElBQVIsRUFBYztBQUNyQixVQUFNQyxNQUFNLEdBQUcsSUFBSUMsZ0JBQUosQ0FBV0gsSUFBWCxFQUFpQkMsSUFBakIsQ0FBZjtBQUVBQyxJQUFBQSxNQUFNLENBQUNFLEVBQVAsQ0FBVSxPQUFWLEVBQW9CQyxLQUFELElBQVcsS0FBS0MsSUFBTCxDQUFVLE9BQVYsRUFBbUJELEtBQW5CLENBQTlCO0FBQ0FILElB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LE1BQU0sR0FBRyxJQUFJQyxhQUFKLENBQVEsS0FBS3ZDLE1BQWIsRUFBcUJrQyxHQUFHLENBQUNFLEtBQXpCLEVBQWdDRixHQUFoQyxDQUFiO0FBQ0EsV0FBSzdCLFVBQUwsQ0FBZ0JtQyxHQUFoQixDQUFvQk4sR0FBRyxDQUFDRSxLQUF4QixFQUErQkUsTUFBL0IsRUFMdUUsQ0FNdkU7O0FBQ0EsVUFBSSxDQUFDSixHQUFHLENBQUNPLEdBQVQsRUFBYztBQUNWLGNBQU1ILE1BQU0sQ0FBQ0ksU0FBUCxFQUFOO0FBQ0g7O0FBQ0QsYUFBT0osTUFBUDtBQUNILEtBWGlDLENBQVosQ0FBdEI7O0FBWUEsU0FBS0ssV0FBTCxDQUFpQmhCLGdCQUFnQixDQUFDVixJQUFqQixDQUFzQmdCLEdBQXRCLENBQTBCQyxHQUFHLElBQUlBLEdBQUcsQ0FBQ0UsS0FBckMsQ0FBakI7O0FBQ0EsV0FBT04sT0FBUDtBQUNIOztBQUVEYSxFQUFBQSxXQUFXLENBQUVDLFVBQUYsRUFBYztBQUNyQkMsSUFBQUEsS0FBSyxDQUFDQyxJQUFOLENBQVcsS0FBS3pDLFVBQUwsQ0FBZ0IwQyxJQUFoQixFQUFYLEVBQW1DQyxPQUFuQyxDQUE0Q0MsT0FBRCxJQUFhO0FBQ3BELFVBQUksQ0FBQ0wsVUFBVSxDQUFDTSxRQUFYLENBQW9CRCxPQUFwQixDQUFMLEVBQW1DO0FBQy9CLGFBQUs1QyxVQUFMLENBQWdCOEMsTUFBaEIsQ0FBdUJGLE9BQXZCO0FBQ0g7QUFDSixLQUpEO0FBS0g7O0FBaEZzQzs7a0JBQXRCdEQsTyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBBY3RvciBmcm9tICcuL2FjdG9yJ1xyXG5pbXBvcnQgQ2xpZW50IGZyb20gJy4vY2xpZW50J1xyXG5pbXBvcnQgVGFiIGZyb20gJy4vdGFiJ1xyXG5pbXBvcnQgb3MgZnJvbSAnb3MnXHJcbmltcG9ydCB7IHNwYXduIH0gZnJvbSAnY2hpbGRfcHJvY2VzcydcclxuXHJcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIEJyb3dzZXIgZXh0ZW5kcyBBY3RvciB7XHJcbiAgICBjb25zdHJ1Y3RvciAoaG9zdCwgcG9ydCkge1xyXG4gICAgICAgIGNvbnN0IGNsaWVudCA9IG5ldyBDbGllbnQoaG9zdCwgcG9ydClcclxuXHJcbiAgICAgICAgY2xpZW50Lm9uKCdlcnJvcicsIChlcnJvcikgPT4gdGhpcy5lbWl0KCdlcnJvcicsIGVycm9yKSlcclxuICAgICAgICBjbGllbnQub24oJ2VuZCcsICgpID0+IHRoaXMuZW1pdCgnZW5kJykpXHJcbiAgICAgICAgY2xpZW50Lm9uKCd0aW1lb3V0JywgKCkgPT4gdGhpcy5lbWl0KCd0aW1lb3V0JykpXHJcblxyXG4gICAgICAgIHN1cGVyKGNsaWVudCwgJ3Jvb3QnKVxyXG4gICAgICAgIHRoaXMuY2FjaGVkVGFicyA9IG5ldyBNYXAoKVxyXG4gICAgfVxyXG5cclxuICAgIGdldCBwcmVmZXJlbmNlICgpIHsgcmV0dXJuIHRoaXMuX2dldCgncHJlZmVyZW5jZScpIH1cclxuICAgIGdldCBhY3RvclJlZ2lzdHJ5ICgpIHsgcmV0dXJuIHRoaXMuX2dldCgnYWN0b3JSZWdpc3RyeScpIH1cclxuICAgIGdldCBhZGRvbnMgKCkgeyByZXR1cm4gdGhpcy5fZ2V0KCdhZGRvbnMnKSB9XHJcbiAgICBnZXQgZGV2aWNlICgpIHsgcmV0dXJuIHRoaXMuX2dldCgnZGV2aWNlJykgfVxyXG4gICAgZ2V0IGhlYXBTbmFwc2hvdEZpbGUgKCkgeyByZXR1cm4gdGhpcy5fZ2V0KCdoZWFwU25hcHNob3RGaWxlJykgfVxyXG5cclxuICAgIGFzeW5jIGNvbm5lY3QgKCkge1xyXG4gICAgICAgIGF3YWl0IHRoaXMuY2xpZW50LmNvbm5lY3QoKVxyXG4gICAgICAgIHRoaXMuY2xpZW50LmV4cGVjdFJlcGx5KHRoaXMubmFtZSwgKHsgdHJhaXRzIH0pID0+IHsgdGhpcy50cmFpdHMgPSB0cmFpdHMgfSlcclxuICAgICAgICB0aGlzLnRhYnMgPSBhd2FpdCB0aGlzLmxpc3RUYWJzKClcclxuICAgICAgICByZXR1cm4gdGhpcy50YWJzXHJcbiAgICB9XHJcblxyXG4gICAgZGlzY29ubmVjdCAoKSB7XHJcbiAgICAgICAgdGhpcy5jbGllbnQuZGlzY29ubmVjdCgpXHJcbiAgICB9XHJcblxyXG4gICAgY2xvc2UgKCkge1xyXG4gICAgICAgIHRoaXMuZGlzY29ubmVjdCgpXHJcblxyXG4gICAgICAgIC8qKlxyXG4gICAgICAgICAqIG9ubHkgc2h1dCBkb3duIGJyb3dzZXIgaWYgc3RhcnRlZCB2aWEgbGF1bmNoZXJcclxuICAgICAgICAgKi9cclxuICAgICAgICBpZiAoIXRoaXMuZmlyZWZveFByb2Nlc3MpIHtcclxuICAgICAgICAgICAgcmV0dXJuIGNvbnNvbGUuZXJyb3IoXHJcbiAgICAgICAgICAgICAgICAnQ2FuXFwndCBjbG9zZSB0aGUgYnJvd3NlciBiZWNhdXNlIGNsaWVudCB3YXMgYXR0YWNoZWQgdG8gYW4nICtcclxuICAgICAgICAgICAgICAgICdhbHJlYWR5IG9wZW5lZCBGaXJlZm94IGluc3RhbmNlJ1xyXG4gICAgICAgICAgICApXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLmZpcmVmb3hQcm9jZXNzLmtpbGwoKVxyXG4gICAgICAgIGlmICghdGhpcy5maXJlZm94UHJvY2Vzcy5raWxsZWQpIHtcclxuICAgICAgICAgICAgaWYgKG9zLnBsYXRmb3JtKCkgPT09ICd3aW4zMicpIHtcclxuICAgICAgICAgICAgICAgIHNwYXduKCd0YXNra2lsbCcsIFsnL2YnLCAnL0lNJywgJ2ZpcmVmb3guZXhlJywgJy90J10pXHJcbiAgICAgICAgICAgIH0gZWxzZSBpZiAob3MucGxhdGZvcm0oKSA9PT0gJ2RhcndpbicgfHwgb3MucGxhdGZvcm0oKSA9PT0gJ2xpbnV4Jykge1xyXG4gICAgICAgICAgICAgICAgc3Bhd24oJ2tpbGxhbGwnLCBbJy1xJywgJy1JJywgJ2ZpcmVmb3gnXSlcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBhc3luYyBsaXN0VGFicyAoKSB7XHJcbiAgICAgICAgbGV0IGxpc3RUYWJzUmVzcG9uc2UgPSBhd2FpdCB0aGlzLnJlcXVlc3QoJ2xpc3RUYWJzJylcclxuICAgICAgICBpZiAoIWxpc3RUYWJzUmVzcG9uc2UudGFicykge1xyXG4gICAgICAgICAgICBsaXN0VGFic1Jlc3BvbnNlID0gYXdhaXQgdGhpcy5yZXF1ZXN0KCdsaXN0VGFicycpXHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuc2V0QWN0b3JzKGxpc3RUYWJzUmVzcG9uc2UpXHJcbiAgICAgICAgY29uc3QgdGFiTGlzdCA9IGF3YWl0IFByb21pc2UuYWxsKGxpc3RUYWJzUmVzcG9uc2UudGFicy5tYXAoYXN5bmMgKHRhYikgPT4ge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5jYWNoZWRUYWJzLmhhcyh0YWIuYWN0b3IpKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5jYWNoZWRUYWJzLmdldCh0YWIuYWN0b3IpXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgbGV0IG5ld1RhYiA9IG5ldyBUYWIodGhpcy5jbGllbnQsIHRhYi5hY3RvciwgdGFiKVxyXG4gICAgICAgICAgICB0aGlzLmNhY2hlZFRhYnMuc2V0KHRhYi5hY3RvciwgbmV3VGFiKVxyXG4gICAgICAgICAgICAvLyBGaXJlZm94IDc1OiBnZXRUYXJnZXRcclxuICAgICAgICAgICAgaWYgKCF0YWIudXJsKSB7XHJcbiAgICAgICAgICAgICAgICBhd2FpdCBuZXdUYWIuZ2V0VGFyZ2V0KClcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gbmV3VGFiXHJcbiAgICAgICAgfSkpXHJcbiAgICAgICAgdGhpcy5fY2xlYW5DYWNoZShsaXN0VGFic1Jlc3BvbnNlLnRhYnMubWFwKHRhYiA9PiB0YWIuYWN0b3IpKVxyXG4gICAgICAgIHJldHVybiB0YWJMaXN0XHJcbiAgICB9XHJcblxyXG4gICAgX2NsZWFuQ2FjaGUgKGFjdGl2ZVRhYnMpIHtcclxuICAgICAgICBBcnJheS5mcm9tKHRoaXMuY2FjaGVkVGFicy5rZXlzKCkpLmZvckVhY2goKHRhYk5hbWUpID0+IHtcclxuICAgICAgICAgICAgaWYgKCFhY3RpdmVUYWJzLmluY2x1ZGVzKHRhYk5hbWUpKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmNhY2hlZFRhYnMuZGVsZXRlKHRhYk5hbWUpXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KVxyXG4gICAgfVxyXG59XHJcbiJdfQ==